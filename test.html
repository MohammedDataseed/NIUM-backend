<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload to Base64</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        #status {
            margin-top: 10px;
            color: #333;
        }

        #progress {
            margin-top: 10px;
        }

        label {
            display: block;
            margin: 10px 0 5px;
        }

        input[type="text"] {
            width: 100%;
            max-width: 400px;
            padding: 5px;
        }
    </style>
</head>

<body>
    <h2>Upload File</h2>
    <label for="partner_order_id">Partner order id:</label>
    <input type="text" id="partner_order_id" placeholder="Enter partner_order_id" value="DOC-PROD">

    <label for="fileInput">Select File:</label>
    <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.pdf">
    <label for="documentTypeId">Document Type ID:</label>
    <input type="text" id="documentTypeId" placeholder="Enter document_type_id"
        value="1e299b0b997038439b9891bd84a72a5fm8easika">
    <label for="apiKey">API Key:</label>
    <input type="text" id="apiKey" placeholder="Enter api_key" value="7b4d9b49-1794-4a91-826a-749cf0d8a87a">
    <label for="partnerId">Partner ID:</label>
    <input type="text" id="partnerId" placeholder="Enter partner_id" value="befb8eadb0fac508d695b7395ec10543m8ctxoh9">
    <label for="partnerId">merge_doc:</label>
    <input type="text" id="merge_doc" placeholder="false/true" value="false">
    <button onclick="uploadFile()">Upload</button>
    <div id="status"></div>
    <div id="progress"></div>

    <script>
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const documentTypeId = document.getElementById('documentTypeId').value;
            const apiKey = document.getElementById('apiKey').value;
            const partnerId = document.getElementById('partnerId').value;
            const partnerOrderId = document.getElementById('partner_order_id').value;
            const mergeDoc = document.getElementById('merge_doc').value;
            const status = document.getElementById('status');
            const progress = document.getElementById('progress');
            const file = fileInput.files[0];

            if (!file) {
                status.textContent = "Please select a file.";
                return;
            }
            if (!documentTypeId || !apiKey || !partnerId) {
                status.textContent = "Please fill in all fields.";
                return;
            }

            status.textContent = "Converting to Base64...";
            const base64String = await fileToBase64(file);
            const chunkSize = 1 * 1024 * 1024; // 1MB chunks for processing
            const totalSize = base64String.length;

            // Process in chunks to avoid freezing, but collect full string
            const chunks = [];
            for (let i = 0; i < totalSize; i += chunkSize) {
                chunks.push(base64String.slice(i, i + chunkSize));
                progress.textContent = `Processed chunk ${chunks.length}/${Math.ceil(totalSize / chunkSize)}`;
            }

            // Combine chunks into full base64 string
            const fullBase64 = chunks.join("");
            status.textContent = "Uploading full file...";

            try {
                const response = await fetch('https://nium.thestorywallcafe.com/v1/api/documents/upload', {
                    method: 'POST',
                    headers: {
                        'accept': '*/*',
                        'api_key': apiKey,       // Use input value
                        'partner_id': partnerId, // Use input value
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        partner_order_id: partnerOrderId,
                        document_type_id: documentTypeId, // Use input value
                        base64_file: fullBase64,          // Send full base64 string at once
                        merge_doc: true,
                    }),
                });

                const result = await response.json();
                progress.textContent = `Uploaded: ${result.message || 'Success'}`;
                status.textContent = "Upload complete!";
            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                progress.textContent = '';
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64WithPrefix = reader.result.toString();
                    const base64Data = base64WithPrefix.split(',')[1]; // Remove prefix
                    resolve(base64Data);
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>

</html>